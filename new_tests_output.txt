============================= test session starts =============================
platform win32 -- Python 3.11.14, pytest-9.0.2, pluggy-1.6.0
rootdir: G:\colour-checker-detection
configfile: pyproject.toml
plugins: anyio-4.12.0, cov-6.3.0, xdist-3.8.0
collected 5 items

colour_checker_detection\tests\test_io.py F.                             [ 40%]
colour_checker_detection\tests\test_detector.py .                        [ 60%]
colour_checker_detection\tests\test_calibrator.py ..                     [100%]

================================== FAILURES ===================================
_________________________ TestIO.test_load_raw_linear _________________________

self = <test_io.TestIO testMethod=test_load_raw_linear>
mock_imread = <MagicMock name='imread' id='2128018937232'>

    @patch("colour_checker_detection.io.rawpy.imread")
    def test_load_raw_linear(self, mock_imread):
        """Test load_raw_linear handling of 16-bit normalization and WB extraction."""
        # Setup mock
        mock_raw = MagicMock()
        mock_context = MagicMock()
        mock_imread.return_value = mock_context
        mock_context.__enter__.return_value = mock_raw
    
        # Mock raw.postprocess return (dummy image 10x10x3)
        # return random int 16bit
        dummy_img = np.random.randint(0, 65535, (10, 10, 3), dtype=np.uint16)
        mock_raw.postprocess.return_value = dummy_img
    
        # Mock WB
        mock_raw.camera_whitebalance = [2.0, 1.0, 1.5, 1.0]
    
        # Call
        path = "dummy.CR2"
        # We need to mock Path.exists to return True
        with patch("pathlib.Path.exists", return_value=True):
            img, wb = load_raw_linear(path)
    
        # Assertions
        self.assertEqual(wb, [2.0, 1.0, 1.5, 1.0])
        self.assertEqual(img.dtype, np.float64) # Should be float after div
        self.assertTrue(np.all(img >= 0) and np.all(img <= 1.0))
    
        # Check rawpy call args
>       mock_raw.postprocess.assert_called_with(
            gamma=(1, 1),
            no_auto_bright=True,
            use_camera_wb=True,
            output_color=0, # rawpy.ColorSpace.raw is usually 0, checking logic
            output_bps=16
        )

colour_checker_detection\tests\test_io.py:43: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <MagicMock name='imread().__enter__().postprocess' id='2128018941456'>
args = ()
kwargs = {'gamma': (1, 1), 'no_auto_bright': True, 'output_bps': 16, 'output_color': 0, ...}
expected = call(gamma=(1, 1), no_auto_bright=True, use_camera_wb=True, output_color=0, output_bps=16)
actual = call(gamma=(1, 1), no_auto_bright=True, use_camera_wb=True, output_color=<ColorSpace.raw: 0>, output_bps=16)
_error_message = <function NonCallableMock.assert_called_with.<locals>._error_message at 0x000001EF79828EA0>
cause = None

    def assert_called_with(self, /, *args, **kwargs):
        """assert that the last call was made with the specified arguments.
    
        Raises an AssertionError if the args and keyword args passed in are
        different to the last call to the mock."""
        if self.call_args is None:
            expected = self._format_mock_call_signature(args, kwargs)
            actual = 'not called.'
            error_message = ('expected call not found.\nExpected: %s\n  Actual: %s'
                    % (expected, actual))
            raise AssertionError(error_message)
    
        def _error_message():
            msg = self._format_mock_failure_message(args, kwargs)
            return msg
        expected = self._call_matcher(_Call((args, kwargs), two=True))
        actual = self._call_matcher(self.call_args)
        if actual != expected:
            cause = expected if isinstance(expected, Exception) else None
>           raise AssertionError(_error_message()) from cause
E           AssertionError: expected call not found.
E           Expected: postprocess(gamma=(1, 1), no_auto_bright=True, use_camera_wb=True, output_color=0, output_bps=16)
E             Actual: postprocess(gamma=(1, 1), no_auto_bright=True, use_camera_wb=True, output_color=<ColorSpace.raw: 0>, output_bps=16)

C:\Users\Victor\AppData\Roaming\uv\python\cpython-3.11.14-windows-x86_64-none\Lib\unittest\mock.py:939: AssertionError
============================= slowest 5 durations =============================
0.01s setup    colour_checker_detection/tests/test_detector.py::TestDetector::test_detect_chart_passthrough
0.01s call     colour_checker_detection/tests/test_io.py::TestIO::test_load_raw_visual

(3 durations < 0.005s hidden.  Use -vv to show these durations.)
=========================== short test summary info ===========================
FAILED colour_checker_detection/tests/test_io.py::TestIO::test_load_raw_linear
======================== 1 failed, 4 passed in 13.09s =========================
